# ATN Account 3 — Distributed Workers + Failover Replicas
# New instance (to provision) | ARM64 4C/24G | Always-on
#
# ROLE: Active-active services (same apps as Account 1+2),
#       Immich ML worker, Paperless OCR worker, LiteLLM fallback.
#       PostgreSQL streaming replica from Account 1.
#
# ACTIVE-ACTIVE: All apps write to Account 1 PG primary over Tailscale.
#   Reads can hit local replica for lower latency.
#   Immich/Paperless workers pull from Redis on Account 2.
#
# CF TUNNEL: Connector 3 (same tunnel as Accounts 1+2).
#   Cloudflare load-balances across all 3 connectors.

services:
  # ════════════════════════════════════════════════════════════════════════
  # NETWORKING
  # ════════════════════════════════════════════════════════════════════════

  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.1"
    networks:
      - atn-net

  # CF tunnel connector 3
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.1"
    networks:
      - atn-net

  # ════════════════════════════════════════════════════════════════════════
  # SHARED INFRASTRUCTURE (PostgreSQL replica)
  # ════════════════════════════════════════════════════════════════════════

  postgres-replica:
    image: tensorchord/pgvecto-rs:pg16-v0.2.1
    container_name: postgres-replica
    restart: unless-stopped
    ports:
      - "5432:5432"
    volumes:
      - postgres-replica-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=atn
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - PGDATA=/var/lib/postgresql/data
    command: >
      bash -c "
        if [ ! -f /var/lib/postgresql/data/standby.signal ]; then
          rm -rf /var/lib/postgresql/data/*
          PGPASSWORD=${POSTGRES_PASSWORD} pg_basebackup -h ${PG_PRIMARY_HOST:-100.67.88.109} -U atn -D /var/lib/postgresql/data -Fp -Xs -P -R
        fi
        exec postgres -c hot_standby=on
      "
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.25"
    networks:
      - atn-net

  # ════════════════════════════════════════════════════════════════════════
  # ACTIVE-ACTIVE SERVICES
  # ════════════════════════════════════════════════════════════════════════

  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    ports:
      - "8222:80"
      - "3012:3012"
    environment:
      - DATABASE_URL=postgresql://atn:${POSTGRES_PASSWORD}@${PG_PRIMARY_HOST:-100.67.88.109}:5432/vaultwarden
      - SIGNUPS_ALLOWED=false
      - INVITATIONS_ALLOWED=true
      - WEBSOCKET_ENABLED=true
      - SHOW_PASSWORD_HINT=false
    env_file:
      - .env
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:80/alive"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
    networks:
      - atn-net

  nextcloud:
    image: nextcloud:stable
    container_name: nextcloud
    restart: unless-stopped
    ports:
      - "8443:80"
    volumes:
      - nextcloud-data:/var/www/html
    environment:
      - POSTGRES_HOST=${PG_PRIMARY_HOST:-100.67.88.109}
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=atn
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=cloud.atnplex.cloud
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    networks:
      - atn-net

  immich-server:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich-server
    restart: unless-stopped
    ports:
      - "2283:2283"
    volumes:
      - immich-upload:/usr/src/app/upload
    environment:
      - DB_HOSTNAME=${PG_PRIMARY_HOST:-100.67.88.109}
      - DB_USERNAME=atn
      - DB_DATABASE_NAME=immich
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - REDIS_HOSTNAME=${REDIS_HOST:-100.102.55.88}
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    networks:
      - atn-net

  immich-ml:
    image: ghcr.io/immich-app/immich-machine-learning:release
    container_name: immich-ml
    restart: unless-stopped
    volumes:
      - immich-ml-cache:/cache
      - immich-upload:/usr/src/app/upload:ro
    environment:
      - REDIS_HOSTNAME=${REDIS_HOST:-100.102.55.88}
    deploy:
      resources:
        limits:
          memory: 3G
          cpus: "1.5"
    networks:
      - atn-net

  paperless:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    container_name: paperless
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - paperless-data:/usr/src/paperless/data
      - paperless-media:/usr/src/paperless/media
      - paperless-consume:/usr/src/paperless/consume
    environment:
      - PAPERLESS_DBHOST=${PG_PRIMARY_HOST:-100.67.88.109}
      - PAPERLESS_DBUSER=atn
      - PAPERLESS_DBPASS=${POSTGRES_PASSWORD}
      - PAPERLESS_DBNAME=paperless
      - PAPERLESS_REDIS=redis://${REDIS_HOST:-100.102.55.88}:6379
      - PAPERLESS_OCR_LANGUAGE=eng
      - PAPERLESS_TASK_WORKERS=2
      - PAPERLESS_URL=https://docs.atnplex.cloud
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "0.5"
    networks:
      - atn-net

  linkwarden:
    image: ghcr.io/linkwarden/linkwarden:latest
    container_name: linkwarden
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://atn:${POSTGRES_PASSWORD}@${PG_PRIMARY_HOST:-100.67.88.109}:5432/linkwarden
      - NEXTAUTH_SECRET=${LINKWARDEN_SECRET}
      - NEXTAUTH_URL=https://links.atnplex.cloud
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.2"
    networks:
      - atn-net

  # ════════════════════════════════════════════════════════════════════════
  # ACCOUNT-SPECIFIC
  # ════════════════════════════════════════════════════════════════════════

  # LiteLLM (active fallback)
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: litellm
    restart: unless-stopped
    ports:
      - "4000:4000"
    volumes:
      - ./litellm_config.yaml:/app/config.yaml:ro
    command: ["--config", "/app/config.yaml", "--port", "4000"]
    env_file:
      - .env
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.2"
    networks:
      - atn-net

  # Uptime Kuma (secondary monitor — cross-checks Account 1 primary)
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: uptime-kuma
    restart: unless-stopped
    ports:
      - "9001:3001"
    volumes:
      - uptime-kuma-data:/app/data
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.2"
    networks:
      - atn-net

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE=0 0 4 * * *
      - TZ=America/Los_Angeles
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.05"

volumes:
  caddy-data:
  caddy-config:
  postgres-replica-data:
  nextcloud-data:
  immich-upload:
  immich-ml-cache:
  paperless-data:
  paperless-media:
  paperless-consume:
  uptime-kuma-data:

networks:
  atn-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
