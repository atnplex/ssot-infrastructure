name: Continuous AI Refactor
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  refactor:
    runs-on: ubuntu-latest
    env:
      RUN_BASE: ${{ runner.temp }}/homelab_global
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq shellcheck make git

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run automation pipeline
        env:
          GEMINI_KEY_1: ${{ secrets.GEMINI_KEY_1 }}
          GEMINI_KEY_2: ${{ secrets.GEMINI_KEY_2 }}
          GEMINI_KEY_3: ${{ secrets.GEMINI_KEY_3 }}
          GEMINI_KEY_4: ${{ secrets.GEMINI_KEY_4 }}
          GEMINI_KEY_5: ${{ secrets.GEMINI_KEY_5 }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/automation/*.sh
          ./scripts/automation/run_once.sh

      - name: Upload refactor logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: refactor-logs-${{ github.run_id }}
          path: ${{ runner.temp }}/homelab_global
          if-no-files-found: warn
