#!/bin/bash
# Single authoritative service wrapper (called by rc.d + WebUI)
set -euo pipefail

CFG_DIR="/boot/config/plugins/cloudflared/config"
TOKEN_FILE="$CFG_DIR/token"
SETTINGS="$CFG_DIR/settings.json"

PIDFILE="/var/run/cloudflared.pid"
RAM_LOG_DIR="/var/log/cloudflared"
LOG_FILE="$RAM_LOG_DIR/cloudflared.log"
WATCHDOG_SCRIPT="/usr/local/emhttp/plugins/cloudflared/scripts/cloudflared-watchdog.sh"
CLOUDFLARED_BIN="/usr/local/sbin/cloudflared"

require_token_file() {
  [ -f "$TOKEN_FILE" ] || { echo "Missing token file: $TOKEN_FILE"; exit 1; }
  [ -s "$TOKEN_FILE" ] || { echo "Token file is empty: $TOKEN_FILE"; exit 1; }
  chmod 0600 "$TOKEN_FILE" 2>/dev/null || true
}

get_log_level() {
  # Default to info if settings file doesn't exist or can't be parsed
  if [ -f "$SETTINGS" ]; then
    # Extract log_level from JSON using simple grep/sed
    grep -o '"log_level"[[:space:]]*:[[:space:]]*"[^"]*"' "$SETTINGS" 2>/dev/null | sed 's/.*"\([^"]*\)".*/\1/' || echo "info"
  else
    echo "info"
  fi
}

is_enabled() {
  # Check if cloudflared is enabled in settings
  if [ -f "$SETTINGS" ]; then
    grep -q '"enabled"[[:space:]]*:[[:space:]]*true' "$SETTINGS" 2>/dev/null
    return $?
  fi
  return 1
}

start_cloudflared() {
  # Check if already running
  if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null; then
    echo "cloudflared is already running (pid $(cat "$PIDFILE"))"
    return 0
  fi

  # Verify cloudflared binary exists
  if [ ! -x "$CLOUDFLARED_BIN" ]; then
    echo "Error: cloudflared binary not found or not executable at $CLOUDFLARED_BIN"
    exit 1
  fi

  # Create log directory
  mkdir -p "$RAM_LOG_DIR"
  touch "$LOG_FILE"

  # Validate token file exists and is not empty
  require_token_file

  # Validate token file content (not just comments)
  if ! grep -q -v '^[[:space:]]*#' "$TOKEN_FILE" | grep -q '[^[:space:]]'; then
    echo "Error: Token file contains no valid token (only comments or empty lines)"
    exit 1
  fi

  # Get log level from settings
  LOG_LEVEL=$(get_log_level)

  echo "Starting cloudflared with log level: $LOG_LEVEL"

  # Start cloudflared in background using --token-file for security
  # This prevents the token from appearing in process lists
  nohup "$CLOUDFLARED_BIN" tunnel run --token-file "$TOKEN_FILE" \
    --loglevel "$LOG_LEVEL" \
    >> "$LOG_FILE" 2>&1 &
  
  CLOUDFLARED_PID=$!
  echo "$CLOUDFLARED_PID" > "$PIDFILE"

  # Wait a moment and verify it started
  sleep 2
  if kill -0 "$CLOUDFLARED_PID" 2>/dev/null; then
    echo "cloudflared started successfully (pid $CLOUDFLARED_PID)"
    
    # Start watchdog in background if enabled
    if [ -x "$WATCHDOG_SCRIPT" ] && is_enabled; then
      # Only start watchdog if not already running
      if ! pgrep -f "cloudflared-watchdog.sh" >/dev/null 2>&1; then
        nohup bash "$WATCHDOG_SCRIPT" >> "$LOG_FILE" 2>&1 &
        echo "Watchdog started"
      fi
    fi
  else
    echo "Error: cloudflared failed to start"
    rm -f "$PIDFILE"
    exit 1
  fi
}

stop_cloudflared() {
  # Stop watchdog first
  if pgrep -f "cloudflared-watchdog.sh" >/dev/null 2>&1; then
    pkill -f "cloudflared-watchdog.sh" 2>/dev/null || true
    echo "Watchdog stopped"
  fi

  # Stop cloudflared
  if [ -f "$PIDFILE" ]; then
    PID=$(cat "$PIDFILE")
    if kill -0 "$PID" 2>/dev/null; then
      echo "Stopping cloudflared (pid $PID)"
      kill "$PID" 2>/dev/null || true
      
      # Wait up to 10 seconds for graceful shutdown
      count=0
      while [ $count -lt 10 ]; do
        if ! kill -0 "$PID" 2>/dev/null; then
          break
        fi
        sleep 1
        count=$((count + 1))
      done
      
      # Force kill if still running
      if kill -0 "$PID" 2>/dev/null; then
        echo "Force stopping cloudflared"
        kill -9 "$PID" 2>/dev/null || true
      fi
      
      echo "cloudflared stopped"
    fi
    rm -f "$PIDFILE"
  else
    # Try to stop any running cloudflared process
    if pgrep -x cloudflared >/dev/null 2>&1; then
      echo "Stopping cloudflared (no pidfile found)"
      pkill -x cloudflared 2>/dev/null || true
      sleep 1
    else
      echo "cloudflared is not running"
    fi
  fi
}

status_cloudflared() {
  if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null; then
    echo "running (pid $(cat "$PIDFILE"))"
    exit 0
  elif pgrep -x cloudflared >/dev/null 2>&1; then
    PID=$(pgrep -x cloudflared)
    echo "running (pid $PID, but pidfile is stale or missing)"
    # Update pidfile
    echo "$PID" > "$PIDFILE"
    exit 0
  fi
  echo "stopped"
  exit 1
}

case "${1:-}" in
  start) start_cloudflared ;;
  stop) stop_cloudflared ;;
  restart) stop_cloudflared; sleep 2; start_cloudflared ;;
  status) status_cloudflared ;;
  *) echo "Usage: $0 {start|stop|restart|status}"; exit 1 ;;
esac
